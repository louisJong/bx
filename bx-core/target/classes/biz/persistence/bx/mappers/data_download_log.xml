<?xml version="1.0" encoding= "UTF-8" ?>        
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="data_download_log">
<resultMap id="data_download_log" type="com.baojing.credit.model.DataDownloadLog">
	<result column="id" property="id"/>
	<result column="user_id" property="userId"/>
	<result column="user_name" property="userName"/>
	<result column="user_type" property="userType"/>
	<result column="user_com_name" property="userComName"/>
	<result column="download_com_name" property="downloadComName"/>
	<result column="download_form_name" property="downloadFormName"/>
	<result column="report_type" property="reportType"/>
	<result column="create_time" property="createTime"/>
	<result column="exception_msg" property="exceptionMsg"/>
	<result column="data_status" property="dataStatus"/>
	<result column="ret_msg" property="retMsg"/>
</resultMap>
<select id="findById" parameterType="long"  resultMap="data_download_log">
	select * 	from data_download_log where id=#{id}  
</select>
<select id="queryRecord" parameterType="hashmap"  resultType="hashmap">
	select log.download_form_name formName , log.create_time accessTime, log.download_com_name comName,log.user_name userName , log.user_type userType , log.report_type level , log.user_com_name userComName
	from data_download_log log 
	<choose>
		<when test="userType =='MAIN'">
			, user_rel_info rel 
			where log.user_id=#{userId} or (log.user_id = rel.sub_user_id and rel.main_user_id=#{userId})
		</when>
		<otherwise>
			where log.user_id=#{userId} and log.user_type=#{userType} 
		</otherwise>
	</choose>
	<if test="searchName!=null and searchName!=''">
		and log.download_com_name  like CONCAT('%','${searchName}','%' )
	</if>
	 and log.data_status='success' and log.create_time between #{startTime} and #{endTime} order by id desc
	 limit #{startRow} , #{limit} 
</select> 			
<select id="queryCount" parameterType="hashmap"  resultType="long">
	select count(1)
	from data_download_log log 
	<choose>
		<when test="userType =='MAIN'">
			, user_rel_info rel 
			where log.user_id=#{userId} or (log.user_id = rel.sub_user_id and rel.main_user_id=#{userId})
		</when>
		<otherwise>
			where log.user_id=#{userId} and log.user_type=#{userType} 
		</otherwise>
	</choose>
	<if test="searchName!=null and searchName!=''">
		and log.download_com_name  like CONCAT('%','${searchName}','%' )
	</if>
	 and log.data_status='success' and log.create_time between #{startTime} and #{endTime}
</select>  
<select id="queryAllRecord" parameterType="hashmap"  resultType="hashmap">
	select log.download_form_name formName , log.create_time accessTime, log.download_com_name comName,log.user_name userName , log.user_type userType , log.report_type level , log.user_com_name userComName
	from data_download_log log 
	<where>
		<if test="userCompany!=null and userCompany!=''">
			and log.user_com_name like CONCAT('%','${userCompany}','%' )
		</if>
		<if test="searchName!=null and searchName!=''">
			and log.download_com_name like CONCAT('%','${searchName}','%' )
		</if>
	 and log.data_status='success' and log.create_time between #{startTime} and #{endTime} 
	</where>
	 order by id desc
	 limit #{startRow} , #{limit} 
</select> 			
<select id="queryAllCount" parameterType="hashmap"  resultType="long">
	select count(1)
	from data_download_log log 
	<where>
		<if test="userCompany!=null and userCompany!=''">
			and log.user_com_name like CONCAT('%','${userCompany}','%' )
		</if>
		<if test="searchName!=null and searchName!=''">
			and log.download_com_name like CONCAT('%','${searchName}','%' )
		</if>
	 	and log.data_status='success' and log.create_time between #{startTime} and #{endTime} 
	</where>
</select>  
<insert id="insert"  parameterType="com.baojing.credit.model.DataDownloadLog"  useGeneratedKeys="true" keyProperty="id">
	insert into data_download_log(id ,user_id ,user_name ,user_type ,user_com_name ,download_com_name ,download_form_name ,report_type ,create_time ,exception_msg ,data_status ,ret_msg)
   values(#{id,jdbcType=INTEGER} ,#{userId,jdbcType=INTEGER} ,#{userName,jdbcType=VARCHAR} ,#{userType,jdbcType=VARCHAR} ,#{userComName,jdbcType=VARCHAR} ,#{downloadComName,jdbcType=VARCHAR} ,#{downloadFormName,jdbcType=VARCHAR} ,#{reportType,jdbcType=VARCHAR} ,#{createTime,jdbcType=TIMESTAMP} ,#{exceptionMsg,jdbcType=VARCHAR} ,#{dataStatus,jdbcType=VARCHAR} ,#{retMsg,jdbcType=VARCHAR}) 
</insert>
<insert id="batchInsert"  parameterType="list">
	insert into data_download_log(id ,user_id ,user_name ,user_type ,user_com_name ,download_com_name ,download_form_name ,report_type ,create_time ,exception_msg ,data_status ,ret_msg)
   values
	<foreach collection="list" item="item" index="index"   separator=","> 
    (#{item.id,jdbcType=INTEGER} ,#{item.userId,jdbcType=INTEGER} ,#{item.userName,jdbcType=VARCHAR} ,#{item.userType,jdbcType=VARCHAR} ,#{item.userComName,jdbcType=VARCHAR} ,#{item.downloadComName,jdbcType=VARCHAR} ,#{item.downloadFormName,jdbcType=VARCHAR} ,#{item.reportType,jdbcType=VARCHAR} ,#{item.createTime,jdbcType=TIMESTAMP} ,#{item.exceptionMsg,jdbcType=VARCHAR} ,#{item.dataStatus,jdbcType=VARCHAR} ,#{item.retMsg,jdbcType=VARCHAR})
	</foreach> 
</insert>
<update id="update"	parameterType="com.baojing.credit.model.DataDownloadLog">
	update data_download_log
<set>
	<if test="userId != null">user_id=#{userId},</if>
	<if test="userName != null">user_name=#{userName},</if>
	<if test="userType != null">user_type=#{userType},</if>
	<if test="userComName != null">user_com_name=#{userComName},</if>
	<if test="downloadComName != null">download_com_name=#{downloadComName},</if>
	<if test="downloadFormName != null">download_form_name=#{downloadFormName},</if>
	<if test="reportType != null">report_type=#{reportType},</if>
	<if test="exceptionMsg != null">exception_msg=#{exceptionMsg},</if>
	<if test="dataStatus != null">data_status=#{dataStatus},</if>
	<if test="retMsg != null">ret_msg=#{retMsg}</if>
</set>
	where id=#{id}
</update>
</mapper>
